---
- hosts: localhost
  tasks:
    - sysctl:
        name: net.ipv4.ip_forward
        state: present
        value: 1
        sysctl_set: yes
    - systemd:
        name: dhcpd
        state: stopped
        enabled: no
    - systemd:
        name: libvirtd
        state: started
        enabled: yes
    - systemd:
        name: openvswitch
        state: started
        enabled: yes
    - virsh_net:
        command: define
        name: default
        xml: '{{ lookup("template", "virsh_network_default.xml.j2") }}'
        state: active
        autostart: yes
    - openvswitch_bridge:
        bridge: 'br-{{ item }}'
        state: present
      with_items: '{{ virsh_enabled_networks }}'
    - virsh_net:
        command: define
        name: '{{ item }}'
        xml: '{{ lookup("template", "virsh_network_ovs.xml.j2") }}'
        state: active
        autostart: yes
      with_items: '{{ virsh_enabled_networks }}'
    - virt_pool:
        name: default
        command: define
        autostart: yes
        state: active
        xml: '{{ lookup("template", "virsh_pool.xml.j2") }}'
    - lineinfile:
        path: /etc/modprobe.d/kvm_intel.conf
        line: 'options kvm-intel nested=1'
      when: ansible_architecture == "x86_64"
    - modeprobe:
        name: "{{ item }}"
        state: present
      with_items:
        - kvm
        - kvm_intel
      when: ansible_architecture == "x86_64"
    - user:
        name: root
        home: no
        generate_ssh_key: yes

