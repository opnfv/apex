---
- hosts: all
  tasks:
    - name: Generate SSH key for stack if missing
        shell: test -e ~/.ssh/id_rsa || ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
    - name: Fix ssh key for stack
        shell: restorecon -r /home/stack
      become: yes
    - copy:
        src: "{{ apex_temp_dir }}/network-environment.yaml"
        dest: /home/stack/network-environment.yaml
        owner: stack
        group: stack
        mode: 0644
    - copy:
        src: "{{ apex_temp_dir }}/{{ item }}.yaml"
        dest: "/home/stack/nics/{{ item}}.yaml"
        owner: stack
        group: stack
        mode: 0644
      with_items:
        - controller
        - compute
    - lineinfile:
        path: /etc/sudoers
        regexp: 'Defaults\s*requiretty'
        state: absent
      become: yes
    - name: openstack-configs undercloud
        shell: openstack-config --set undercloud.conf DEFAULT {{ item }}
      with_items: "{{ undercloud_config }}"
    - name: openstack-configs ironic
        shell: openstack-config --set ironic.conf {{ item }}
      become: yes
      with_items: "{{ ironic_config }}"
    - name: openstack-configs undercloud aarch64
        shell: openstack-config --set undercloud.conf DEFAULT ipxe_enabled false
      when: {{ aarch64 }}
    - lineinfile:
        path: /usr/lib/python2.7/site-packages/ironic/common/pxe_utils.py
        regexp: '_link_ip_address_pxe_configs'
        line: '_link_mac_pxe_configs(task)'
      when: {{ aarch64 }}
    - name: undercloud install
        shell: openstack undercloud install &> apex-undercloud-install.log
